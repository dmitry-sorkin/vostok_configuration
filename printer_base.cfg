# Базовая конфигурация VOSTOK v9.0
# ------------------------
# Файл распространяется под лицензией CC-BY 4.0
# ------------------------
# !!! НЕ ВНОСИТЕ ИЗМЕНЕНИЯ В ЭТОТ ФАЙЛ !!!
# Если вам необходимо изменить какие-то из параметров или
# макросов, содержащихся в этом файле, то следуйте инструкции,
# размещённой в printer.cfg
#
#####################################
# Основное
#####################################

[printer]
kinematics: generic_cartesian

[force_move]
enable_force_move: True

[input_shaper]

[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[pause_resume]

[display_status]

[respond]

[exclude_object]

[sdcard_loop]

[gcode_arcs]

#####################################
# Каретки
#####################################

[carriage xc]
axis: x
homing_speed: 100
homing_retract_dist: 0

[dual_carriage wc]
primary_carriage: xc
homing_speed: 100
homing_retract_dist: 3
second_homing_speed: 6

[carriage ylc]
axis: y
homing_speed: 100
homing_retract_dist: 3
second_homing_speed: 6

[extra_carriage yrc]
primary_carriage: ylc

[carriage zc]
axis: z
position_min: -1
homing_retract_dist: 3
second_homing_speed: 6
endstop_pin: probe:z_virtual_endstop

#####################################
# Двигатели
#####################################

[stepper motor_x]
carriages: xc
microsteps: 256
rotation_distance: 40

[stepper motor_w]
carriages: wc
microsteps: 256
rotation_distance: 40

[stepper motor_yl]
carriages: ylc
microsteps: 256
rotation_distance: 40

[stepper motor_yr]
carriages: yrc
microsteps: 256
rotation_distance: 40

[stepper motor_z]
carriages: zc
microsteps: 16
rotation_distance: 4

#####################################
# Экструдеры
#####################################

[extruder]
nozzle_diameter: 0.400
filament_diameter: 1.750
min_temp: 0
max_extrude_cross_section: 999999
max_extrude_only_distance: 200
microsteps: 16

[extruder1]
nozzle_diameter: 0.400
filament_diameter: 1.750
min_temp: 0
max_extrude_cross_section: 999999
max_extrude_only_distance: 200
microsteps: 16

#####################################
# Стол и автоуровень
#####################################

[heater_bed]
min_temp: 0
max_temp: 120

[probe]
deactivate_on_each_sample: False
speed: 5.0
activate_gcode:
    PROBE_DEPLOY
    G4 P500
deactivate_gcode:
    PROBE_STOW

[bed_mesh]
speed: 300
horizontal_move_z: 3
fade_start: 1.0
fade_end: 10.0
algorithm: bicubic

[screws_tilt_adjust]
horizontal_move_z: 10
speed: 500

[homing_override]
gcode:
    # Если G28 вызван без параметров или со всеми парааметрами, значит паркуем все оси
    {% set home_all = not('X' in params or 'Y' in params or 'Z' in params) or ('X' in params and 'Y' in params and 'Z' in params) %}
    # Если указано парковать ось Z, то проверяем возможность этого
    {% if 'Z' in params and not home_all %}
        {% if not ('x' in printer.toolhead.homed_axes and 'y' in printer.toolhead.homed_axes) %}
            {action_emergency_stop('Индивидуальная парковка оси Z невозможна, если не припаркованы оси XY')}
        {% endif %}
    {% endif %}
    # Сохраняем состояние принтера до парковки
    SAVE_GCODE_STATE NAME=homing_gcode_state
    SAVE_DUAL_CARRIAGE_STATE NAME=homing_dual_carriage_state
    # Если необходима парковка оси X или Y, то сдвигаем стол на 2мм вниз для безопасности
    {% if 'X' in params or 'Y' in params or home_all %}
        FORCE_MOVE STEPPER='stepper motor_z' DISTANCE=2 VELOCITY=5
    {% endif %}
    {% if 'Y' in params or home_all %}
        # Если есть параметр Y, или паркуем все оси, то начинаем с парковки оси Y
        G28 Y0
    {% endif %}
    {% if 'X' in params or home_all %}
        # Если есть параметр X, или паркуем все оси, то паркуем X и W
        G28 X0
        IDEX_MODE_FULL_CONTROL LOG=0
        G90
        {% if home_all or 'Z' in params %}
            # Если паркуем все оси, то перемещаем X в центр стола, а W в максимальную координату
            G1 X{ printer.configfile.config["carriage xc"].position_max|float / 2 - printer.configfile.config["probe"].x_offset|float } W{ printer.configfile.config["dual_carriage wc"].position_max|float - printer['gcode_macro _IDEX_SETTINGS'].safety_offset|float } Y{ printer.configfile.config["carriage ylc"].position_max|float / 2 - printer.configfile.config["probe"].y_offset|float } F30000
        {% else %}
            # Если парковали только X, то перемещаем W в максимальную координату
            PARK_W
        {% endif %}        
        IDEX_RESET LOG=0
    {% endif %}
    {% if home_all or 'Z' in params %}
        # Если мы парковали только X или Y, то Z парковать не нужно. Если паркуем все оси, то нужно
        # Проверяем, находится ли печатающая голова в пределах стола
        {% set x_min_check = printer.toolhead.position.x|float >= printer.configfile.config["carriage xc"].position_min|default(0)|float - printer.configfile.config["probe"].x_offset|float %}
        {% set x_max_check = printer.toolhead.position.x|float <= printer.configfile.config["carriage xc"].position_max|float - printer.configfile.config["probe"].x_offset|float %}
        {% set y_min_check = printer.toolhead.position.y|float >= printer.configfile.config["carriage ylc"].position_min|default(0)|float - printer.configfile.config["probe"].y_offset|float %}
        {% set y_max_check = printer.toolhead.position.y|float <= printer.configfile.config["carriage ylc"].position_max|float - printer.configfile.config["probe"].y_offset|float %}
        {% if x_min_check and x_max_check and y_min_check and y_max_check %}
            G28 Z
            G1 Z5 F1200
        {% else %}
            {action_emergency_stop("Датчик автоуровня находится не над столом. Парковка оси Z невозможна")}
        {% endif %}
    {% endif %}
    # Если паркуем все оси, то после парковки возвращаем всё в базовые позиции
    {% if home_all %}
        PARK_XW
    {% endif %}
    # Восстанавливаем состояние принтера, которое было до парковки
    RESTORE_DUAL_CARRIAGE_STATE NAME=homing_dual_carriage_state MOVE=0
    RESTORE_GCODE_STATE NAME=homing_gcode_state MOVE=0
    # Если в настройках IDEX (printer.cfg) указано сбрасывать режим работы IDEX при парковке, то сбрасываем
    {% if printer["gcode_macro _IDEX_SETTINGS"].reset_on_g28|default(1)|int == 1 %}
        IDEX_RESET
        SET_GCODE_VARIABLE MACRO=_IDEX_VARIABLES VARIABLE=active_tool VALUE=0
    {% endif %}

#####################################
# Вентиляторы
#####################################

[fan]
max_power: 1.0

[heater_fan e0_fan]
heater: extruder
heater_temp: 40.0
fan_speed: 1.0

[heater_fan e1_fan]
heater: extruder1
heater_temp: 40.0
fan_speed: 1.0

[controller_fan electronics_fan]
heater: extruder, extruder1, heater_bed
stepper: stepper motor_x, stepper motor_w, stepper motor_yl, stepper motor_yr, stepper motor_z, extruder, extruder1
fan_speed: 1.0

#####################################
# Макросы
#####################################

[gcode_macro _IDEX_VARIABLES]
variable_active_tool: 0
variable_equal_pa_mode: 0
gcode:

[gcode_macro PARK_X]
gcode:
	# Макрос, паркующий левую печатающую голову. Не вызывает переключение режима работы IDEX
    SAVE_GCODE_STATE NAME=park_gs
    SAVE_DUAL_CARRIAGE_STATE NAME=park_dcs
    IDEX_RESET LOG=0
    SET_GCODE_OFFSET X=0
    G90
    G1 X{printer.configfile.settings['carriage xc'].position_min|float + printer['gcode_macro _IDEX_SETTINGS'].safety_offset|float} F30000
    RESTORE_DUAL_CARRIAGE_STATE NAME=park_dcs MOVE=0
    RESTORE_GCODE_STATE NAME=park_gs MOVE=0

[gcode_macro PARK_W]
gcode:
	# Макрос, который паркует правую печатающую голову. Не вызывает переключение режима работы IDEX
    SAVE_GCODE_STATE NAME=park_gs
    SAVE_DUAL_CARRIAGE_STATE NAME=park_dcs
    IDEX_MODE_FULL_CONTROL LOG=0
    SET_GCODE_OFFSET W=0
    G90
    G1 W{printer.configfile.settings['dual_carriage wc'].position_max|float - printer['gcode_macro _IDEX_SETTINGS'].safety_offset|float} F30000
    RESTORE_DUAL_CARRIAGE_STATE NAME=park_dcs MOVE=0
    RESTORE_GCODE_STATE NAME=park_gs MOVE=0
	
[gcode_macro PARK_XW]
gcode:
	# Макрос, который паркует обе печатающие головы. Не вызывает переключение режима работы IDEX
    SAVE_GCODE_STATE NAME=park_gs
    SAVE_DUAL_CARRIAGE_STATE NAME=park_dcs
    IDEX_MODE_FULL_CONTROL LOG=0
    SET_GCODE_OFFSET X=0 W=0
    G90
    G1 X{printer.configfile.settings['carriage xc'].position_min|float + printer['gcode_macro _IDEX_SETTINGS'].safety_offset|float} W{printer.configfile.settings['dual_carriage wc'].position_max|float - printer['gcode_macro _IDEX_SETTINGS'].safety_offset|float} F30000
    RESTORE_DUAL_CARRIAGE_STATE NAME=park_dcs MOVE=0
    RESTORE_GCODE_STATE NAME=park_gs MOVE=0
	

[gcode_macro IDEX_MODE_FULL_CONTROL]
description: 
gcode:
	# Макрос, включащий режим полного контроля IDEX. При этом левая печатающая голова контролируется через ось X,
	# а правая - через ось W. К примеру, команда 'G1 X20 W100' одновременно переместит левую голову в координату 20,
	# а правую в координату 100. Параметры:
	# LOG=<0|1> - если указано 1, то в консоль будет выведено сообщение о переключении режима. По умолчанию 1
    SET_DUAL_CARRIAGE CARRIAGE=xc MODE=PRIMARY
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SET_DUAL_CARRIAGE CARRIAGE=wc MODE=DIRECT GCODE_AXIS=W
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1
    {% if params.LOG|default(1)|int %}
        { action_respond_info("IDEX: Активирован режим полного контроля") }
    {% endif %}

[gcode_macro IDEX_RESET]
gcode:
	# Макрос, сбрасывающий режим работы IDEX. После него будет задействована левая печатающая голова. Параметры:
	# LOG=<0|1> - если указано 1, то в консоль будет выведено сообщение о переключении режима. По умолчанию 1
    SET_DUAL_CARRIAGE CARRIAGE=xc MODE=PRIMARY
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1
    {% if params.LOG|default(1)|int %}
        { action_respond_info("IDEX: Активирован стандартный режим работы") }
    {% endif %}

[gcode_macro IDEX_MODE_COPY]
gcode:
	# Макрос, который переводит IDEX в повторяющий режим. Параметры:
	# PRINTHEAD_DISTANCE=<значение> - расстояние между печатающими головами. Если не указано, то будет использовано
	#                                  значение по умолчанию из printer.cfg
	# MOVE=<0|1> - если указано 1, то правая печатающая голова будет перемещена на PRINTHEAD_DISTANCE относительно левой. По умолчанию 0
	# LOG=<0|1> - если указано 1, то в консоль будет выведено сообщение о переключении режима. По умолчанию 1
    {% if params.MOVE|default(0)|int == 1 %}
        # Если нужно подвинуть головы в положение перед печатью
        {% if 'PRINTHEAD_DISTANCE' in params %}
            # Если PRINTHEAD_DISTANCE указан, то использовать его
            {% set D = params.PRINTHEAD_DISTANCE|float %}
            # Проверить, не указан ли слишком маленький PRINTHEAD_DISTANCE
            {% if D < ( printer.configfile.settings['dual_carriage wc'].safe_distance|float + 1 )%}
                { action_emergency_stop("PRINTHEAD_DISTANCE не может быть меньше расстояния между осями хотэндов печатающих голов, когда те находятся максимально близко друг к другу") }
            {% endif %}
        {% else %}
            # Если PRINTHEAD_DISTANCE не указан, то использовать стандартное значение
            {% set D = printer["gcode_macro _IDEX_SETTINGS"].default_printhead_distance|float %}
        {% endif %}
        IDEX_MODE_FULL_CONTROL
        # Вычислить координату правой печатающей головы после сдвига на PRINTHEAD_DISTANCE относительно левой
        {% set W_position = printer.toolhead.position.x|float + D %}
        # Проверить, не выходит ли W за пределы области печати
        {% if W_position > printer.configfile.settings['dual_carriage wc'].position_max|float %}
            { action_emergency_stop("Положение левой печатающей головы или величина PRINTHEAD_DISTANCE такие, что позиция, в которую должна была переместиться правая печатающая голова, оказалась за пределами области печати") }
        {% endif %}
        # Переместить правую печатающую голову на расстояние PRINTHEAD_DISTANCE от левой
        G1 W{W_position} F30000
    {% endif %}
    # Перевести принтер в режим копирования
    SET_DUAL_CARRIAGE CARRIAGE=xc MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=wc MODE=COPY
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder
    M400
    {% if params.LOG|default(1)|int == 1 %}
        { action_respond_info("IDEX: Активирован режим копирования") }
    {% endif %}

[gcode_macro IDEX_MODE_MIRROR]
gcode:
	# Макрос, который переводит IDEX в зеркальный режим. Параметры:
	# MOVE=<0|1> - если указано 1, то обе печатающие головы будут переведены в базовое положение. Если 0, то головы перемещаться не будут. По умолчанию 0
	# LOG=<0|1> - если указано 1, то в консоль будет выведено сообщение о переключении режима. По умолчанию 1
    {% if params.MOVE|default(0)|int == 1 %}
        PARK_XW
    {% endif %}
    SET_DUAL_CARRIAGE CARRIAGE=xc MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=wc MODE=MIRROR
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder
    {% if params.LOG|default(1)|int == 1 %}
        { action_respond_info("IDEX: Активирован режим зеркального движения") }
    {% endif %}

[gcode_macro T0]
gcode:
    # Макрос смены инструмента, совместимый со скриптом быстрой смены инструмента от Дмитрий Бутюгина
    # (https://github.com/dmbutyugin/klipper/blob/generic-cartesian/scripts/gcode/fast_tool_swaps.py)
    # Если передать в него параметры X, Y, Z в любом сочетании, то печатающая голова будет перемещена
    # в указанные координаты
    {% if printer["gcode_macro _IDEX_VARIABLES"].active_tool != 0 %}
        SET_GCODE_OFFSET X=0 Y=0
        {% if ('x' in printer.toolhead.homed_axes) %}
            {% set x = "" if (params.X|default(none) is none) else "X" ~ params.X %}
            {% set y = "" if (params.Y|default(none) is none) else "Y" ~ params.Y %}
            {% set z = "" if (params.Z|default(none) is none) else "Z" ~ params.Z %}
            {% set w_park_pos = printer.configfile.settings['dual_carriage wc'].position_max|float - 0.5 %}
            IDEX_MODE_FULL_CONTROL LOG=0
            G1 {x} W{w_park_pos} {y} {z}
        {% endif %}
        ACTIVATE_EXTRUDER EXTRUDER=extruder
        SET_DUAL_CARRIAGE CARRIAGE=xc
        SET_GCODE_VARIABLE MACRO=_IDEX_VARIABLES VARIABLE=active_tool VALUE=0
    {% endif %}

[gcode_macro T1]
gcode:
    # Макрос смены инструмента, совместимый со скриптом быстрой смены инструмента от Дмитрий Бутюгина
    # (https://github.com/dmbutyugin/klipper/blob/generic-cartesian/scripts/gcode/fast_tool_swaps.py)
    # Если передать в него параметры X, Y, Z в любом сочетании, то печатающая голова будет перемещена
    # в указанные координаты
    {% if printer["gcode_macro _IDEX_VARIABLES"].active_tool != 1 %}
        SET_GCODE_OFFSET X={0.0-(printer['gcode_macro _IDEX_SETTINGS'].right_printhead_x_offset|float)} Y={0.0-(printer['gcode_macro _IDEX_SETTINGS'].right_printhead_y_offset|float)}
        {% if ('x' in printer.toolhead.homed_axes) %}
            {% set w = "" if (params.X|default(none) is none) else "W" ~ params.X %}
            {% set y = "" if (params.Y|default(none) is none) else "Y" ~ params.Y %}
            {% set z = "" if (params.Z|default(none) is none) else "Z" ~ params.Z %}
            {% set x_park_pos = printer.configfile.settings['carriage xc'].position_min|float + printer['gcode_macro _IDEX_SETTINGS'].safety_offset|float - printer['gcode_macro _IDEX_SETTINGS'].right_printhead_x_offset|float %}
            IDEX_MODE_FULL_CONTROL LOG=0
            G1 X{x_park_pos} {w} {y} {z}
        {% endif %}
        ACTIVATE_EXTRUDER EXTRUDER=extruder1
        SET_DUAL_CARRIAGE CARRIAGE=wc
        SET_GCODE_VARIABLE MACRO=_IDEX_VARIABLES VARIABLE=active_tool VALUE=1
    {% endif %}

[gcode_macro SET_W_OFFSETS]
gcode:
	# Установка смещений правой печатающей головы
	# Эти смещения работают только при классическом режиме работы, то есть когда одновременно
	# задействована только одна печатающая голова. В зеркальном и повторяющем режимах эти смещения не учитываются.
	# Смещения по Z нет т.к. у VOSTOK печатающие головы должны быть физически выставлены в один уровень с помощью регулировок на печатающей голове
	# Параметры:
	# X=<значение> - смещение по X. Положительное значение смещает голову вправо. Отрицательное влево
	# Y=<значение> - смещение по Y. Положительное значение смещает голову ближе к задней части принтера. Отрицательное - ближе к передней
    {% if 'X' in params or 'Y' in params %}
        {% if 'X' in params %}
            SET_GCODE_VARIABLE MACRO=_IDEX_SETTINGS VARIABLE=right_printhead_x_offset VALUE={params.X|float}
        {% endif %}
        {% if 'Y' in params %}
            SET_GCODE_VARIABLE MACRO=_IDEX_SETTINGS VARIABLE=right_printhead_y_offset VALUE={params.Y|float}
        {% endif %}
    {% else %}
        {action_raise_error("Макрос установки смещений правой печатающей головы (SET_W_OFFSETS) вызван без передачи смещений (X и/или Y)")}
    {% endif %}

[gcode_macro PRINT_START_CLASSIC]
gcode:
    # Макрос начала печати для классического режима работы IDEX. То есть либо печать одной печатающей головой, либо печать двумя попеременно. Параметры:
    # E0_TEMPERATURE=<значение> - температура хотэнда левой печатающей головы. Обязательный параметр. Если голова не должна использоваться, то стоит передать 0
    # E1_TEMPERATURE=<значение> - температура хотэнда правой печатающей головы. Обязательный параметр. Если голова не должна использоваться, то стоит передать 0
    # BED_TEMPERATURE=<значение> - температура стола. Если значение не передано, то температура будет сброшена до 0
    # E0_PA=<значение> - значение Pressure Advance для левой печатающей головы. Если значение не передано, то PA для этой печатающей головы будет отключен
    # E1_PA=<значение> - значение Pressure Advance для правой печатающей головы. Если значение не передано, то PA для этой печатающей головы будет отключен
    # E0_PA_SMOOTH_TIME=<значение> - значение времени сглаживания Pressure Advance для левой печатающей головы. Если значение не передано, то будет установлено 0.02с
    # E1_PA_SMOOTH_TIME=<значение> - значение времени сглаживания Pressure Advance для правой печатающей головы. Если значение не передано, то будет установлено 0.02с
    # ------------------------------------
    # Проверка, переданы ли температуры для хотэндов. Если какой-то хотэнд не используется, то для него должна быть передана нулевая температура
    {% if params.E0_TEMPERATURE is not defined or params.E1_TEMPERATURE is not defined %}
        {action_emergency_stop("Вызван макрос начала печати (PRINT_START) без указания температур хотэндов. Параметры E0_TEMPERATURE и E1_TEMPERATURE обязательны")}
    {% endif %}
    # Современные хотэнды греются настолько быстро, что запуск их нагрева одновременно с нагревом стола почти не экономит времени. Пусть лучше хотэнд дольше будет холодным, и из него успеет натечь меньше филамента. Также важно полностью прогреть стол перед парковкой
    M190 S{params.BED_TEMPERATURE|default(0)|int}
    # Делаем автопарковку, снимаем карту высот и возвращаем левую печатающую голову в базовую позицию
    G28
    BED_MESH_CALIBRATE ADAPTIVE=1
    PARK_X
    # Если выключен сброс режима IDEX при парковке, то всё равно сбрасываем
    {% if printer["gcode_macro _IDEX_SETTINGS"].reset_on_g28|int == 0 %}
        IDEX_RESET
    {% endif %}
    # Прогреваем хотэнды до заданной температуры
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={params.E0_TEMPERATURE|int}
    {% if params.E1_TEMPERATURE|default(0)|int != 0 %}
        SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET={params.E1_TEMPERATURE|int}
        TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={params.E1_TEMPERATURE|int - 1} MAXIMUM={params.E1_TEMPERATURE|int + 1}
    {% endif %}
    {% if params.E0_TEMPERATURE|default(0)|int != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.E0_TEMPERATURE|int - 1} MAXIMUM={params.E0_TEMPERATURE|int + 1}
    {% endif %}
    # Устанавливаем значения Pressure Advance для обеих печатающих голов. Если они не указаны, устанавливаем стандартные (PA=0.0, PA_smooth_time=0.02)
    SET_PRESSURE_ADVANCE EXTRUDER=extruder ADVANCE={params.E0_PA|default(0.0)|float} SMOOTH_TIME={params.E0_PA_SMOOTH_TIME|default(0.02)|float}
    SET_PRESSURE_ADVANCE EXTRUDER=extruder1 ADVANCE={params.E1_PA|default(0.0)|float} SMOOTH_TIME={params.E1_PA_SMOOTH_TIME|default(0.02)|float}
    G92 E0
	
[gcode_macro PRINT_START_MIRROR]
gcode:
	# Макрос начала печати для зеркального режима работы IDEX. Параметры:
	# E0_TEMPERATURE=<значение> - температура хотэнда левой печатающей головы. Обязательный параметр. Не может быть ниже 140
    # E1_TEMPERATURE=<значение> - температура хотэнда правой печатающей головы. Обязательный параметр. Не может быть ниже 140
    # BED_TEMPERATURE=<значение> - температура стола. Если значение не передано, то температура будет сброшена до 0
    # E0_PA=<значение> - значение Pressure Advance для левой печатающей головы. Если значение не передано, то PA для этой печатающей головы будет отключен
    # E1_PA=<значение> - значение Pressure Advance для правой печатающей головы. Если значение не передано, то PA для этой печатающей головы будет отключен
    # E0_PA_SMOOTH_TIME=<значение> - значение времени сглаживания Pressure Advance для левой печатающей головы. Если значение не передано, то будет установлено 0.02с
    # E1_PA_SMOOTH_TIME=<значение> - значение времени сглаживания Pressure Advance для правой печатающей головы. Если значение не передано, то будет установлено 0.02с
    # ------------------------------------
	# Проверка, указаны ли температуры хотэндов
	{% if params.E0_TEMPERATURE is not defined or params.E1_TEMPERATURE is not defined %}
        {action_emergency_stop("Вызван макрос начала печати (PRINT_START) без указания температур хотэндов. Параметры E0_TEMPERATURE и E1_TEMPERATURE обязательны")}
	{% elif params.E0_TEMPERATURE|int == 0 or params.E1_TEMPERATURE == 0 %}
		{action_emergency_stop("В макрос начала печати (PRINT_START) передана нулевая температура хотэнда")}
    {% endif %}
	# Современные хотэнды греются настолько быстро, что запуск их нагрева одновременно с нагревом стола почти не экономит времени. Пусть лучше хотэнд дольше будет холодным, и из него успеет натечь меньше филамента. Также важно полностью прогреть стол перед парковкой
	M190 S{params.BED_TEMPERATURE|default(0)|int}
	# Делаем автопарковку и сбрасываем карту высот т.к. в зеркальном и повторяющем режиме карту высот использовать нельзя
	G28
	BED_MESH_CLEAR
	# Включаем зеркальный режим с перемещением печатающих голов в базовые позиции
	IDEX_MODE_MIRROR MOVE=1
	# Прогреваем хотэнды
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={params.E0_TEMPERATURE|int}
	SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET={params.E1_TEMPERATURE|int}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.E0_TEMPERATURE|int - 1} MAXIMUM={params.E0_TEMPERATURE|int + 1}
	TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={params.E1_TEMPERATURE|int - 1} MAXIMUM={params.E1_TEMPERATURE|int + 1}
	# Устанавливаем значения Pressure Advance для обеих печатающих голов. Если они не указаны, устанавливаем стандартные (PA=0.0, PA_smooth_time=0.02)
    SET_PRESSURE_ADVANCE EXTRUDER=extruder ADVANCE={params.E0_PA|default(0.0)|float} SMOOTH_TIME={params.E0_PA_SMOOTH_TIME|default(0.02)|float}
    SET_PRESSURE_ADVANCE EXTRUDER=extruder1 ADVANCE={params.E1_PA|default(0.0)|float} SMOOTH_TIME={params.E1_PA_SMOOTH_TIME|default(0.02)|float}
    G92 E0
	
[gcode_macro PRINT_START_COPY]
gcode:
	# Макрос начала печати для дублирующего (повторяющего) режима работы IDEX. Параметры:
	# E0_TEMPERATURE=<значение> - температура хотэнда левой печатающей головы. Обязательный параметр. Не может быть ниже 140
    # E1_TEMPERATURE=<значение> - температура хотэнда правой печатающей головы. Обязательный параметр. Не может быть ниже 140
    # BED_TEMPERATURE=<значение> - температура стола. Если значение не передано, то температура будет сброшена до 0
    # E0_PA=<значение> - значение Pressure Advance для левой печатающей головы. Если значение не передано, то PA для этой печатающей головы будет отключен
    # E1_PA=<значение> - значение Pressure Advance для правой печатающей головы. Если значение не передано, то PA для этой печатающей головы будет отключен
    # E0_PA_SMOOTH_TIME=<значение> - значение времени сглаживания Pressure Advance для левой печатающей головы. Если значение не передано, то будет установлено 0.02с
    # E1_PA_SMOOTH_TIME=<значение> - значение времени сглаживания Pressure Advance для правой печатающей головы. Если значение не передано, то будет установлено 0.02с
	# PRINTHEAD_DISTANCE=<значение> - расстояние между печатающими головами. Если не указано, то будет использовано значение по умолчанию из printer.cfg
    # ------------------------------------
	# Проверка, указаны ли температуры хотэндов
	{% if params.E0_TEMPERATURE is not defined or params.E1_TEMPERATURE is not defined %}
        {action_emergency_stop("Вызван макрос начала печати (PRINT_START) без указания температур хотэндов. Параметры E0_TEMPERATURE и E1_TEMPERATURE обязательны")}
	{% elif params.E0_TEMPERATURE|int == 0 or params.E1_TEMPERATURE == 0 %}
		{action_emergency_stop("В макрос начала печати (PRINT_START) передана нулевая температура хотэнда")}
    {% endif %}
	# Современные хотэнды греются настолько быстро, что запуск их нагрева одновременно с нагревом стола почти не экономит времени. Пусть лучше хотэнд дольше будет холодным, и из него успеет натечь меньше филамента. Также важно полностью прогреть стол перед парковкой
	M190 S{params.BED_TEMPERATURE|default(0)|int}
	# Делаем автопарковку и сбрасываем карту высот т.к. в зеркальном и повторяющем режиме карту высот использовать нельзя
	G28
	BED_MESH_CLEAR
	# Проверяем, указано ли расстояние между печатающими головами в параметрах, после чего переключаем IDEX в повторяющий режим с перемещением печатающих голов в базовые позиции
	{% if params.PRINTHEAD_DISTANCE is not defined %}
		IDEX_MODE_COPY MOVE=1 PRINTHEAD_DISTANCE={printer["gcode_macro _IDEX_SETTINGS"].default_printhead_distance|float}
	{% else %}
		IDEX_MODE_COPY MOVE=1 PRINTHEAD_DISTANCE={params.PRINTHEAD_DISTANCE|float}
	{% endif %}
	# Прогреваем хотэнды
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={params.E0_TEMPERATURE|int}
	SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET={params.E1_TEMPERATURE|int}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.E0_TEMPERATURE|int - 1} MAXIMUM={params.E0_TEMPERATURE|int + 1}
	TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={params.E1_TEMPERATURE|int - 1} MAXIMUM={params.E1_TEMPERATURE|int + 1}
	# Устанавливаем значения Pressure Advance для обеих печатающих голов. Если они не указаны, устанавливаем стандартные (PA=0.0, PA_smooth_time=0.02)
    SET_PRESSURE_ADVANCE EXTRUDER=extruder ADVANCE={params.E0_PA|default(0.0)|float} SMOOTH_TIME={params.E0_PA_SMOOTH_TIME|default(0.02)|float}
    SET_PRESSURE_ADVANCE EXTRUDER=extruder1 ADVANCE={params.E1_PA|default(0.0)|float} SMOOTH_TIME={params.E1_PA_SMOOTH_TIME|default(0.02)|float}
    G92 E0
	
[gcode_macro PRINT_END]
gcode:
	# Макрос окончания печати. Сбрасывает режим работы, выключает нагреватели и вентиляторы, паркует обе печатающие головы, сдвигает стол в крайнее нижнее положение
	M220 S100
    M221 S100
    TURN_OFF_HEATERS
	M106 S0
	G91
	G1 Z1 F{printer.configfile.settings['printer'].max_z_velocity|float * 60}
	PARK_XW
    G90
	G1 Z{printer.configfile.settings['carriage zc'].position_max|float - 2} F{printer.configfile.settings['printer'].max_z_velocity|float * 60}
    M84
	
[gcode_macro CANCEL_PRINT]
description: Отмена текущей печати
rename_existing: CANCEL_PRINT_BASE
gcode:
	PRINT_END
	CANCEL_PRINT_BASE
	
[gcode_macro PAUSE]
description: Приостановка текущей печати
rename_existing: PAUSE_BASE
gcode:
	SAVE_GCODE_STATE NAME=pause_gs
	G91
	G1 Z1 F{printer.configfile.settings['printer'].max_z_velocity|float * 60}
	PARK_XW
    RESTORE_GCODE_STATE NAME=pause_gs MOVE=0
	PAUSE_BASE

# Команды, необходимые для работы макроса IDEX_SHAPER_CALIBRATION
[gcode_shell_command remove_calibration_data]
command: bash -c "rm -rf /tmp/*_data_*.csv"

[gcode_shell_command create_x_shaper_graph]
command: bash -c "~/klipper/scripts/calibrate_shaper.py /tmp/*_data_x*.csv -o ~/printer_data/config/x.png"
timeout: 60.0

[gcode_shell_command create_w_shaper_graph]
command: bash -c "~/klipper/scripts/calibrate_shaper.py /tmp/*_data_x*.csv -o ~/printer_data/config/w.png"
timeout: 60.0

[gcode_shell_command create_y_shaper_graph]
command: bash -c "~/klipper/scripts/calibrate_shaper.py /tmp/*_data_y*.csv -o ~/printer_data/config/y.png"
timeout: 60.0

[gcode_macro IDEX_SHAPER_CALIBRATE]
gcode:
    # Макрос калибровки Input Shaping, учитывающий особенности IDEX принтеров. Требует установки
    # GCODE_SHELL_COMMAND, который можно установить через KIAUH в разделе Extensions.
    # Этот макрос работает следующим образом:
    # 1. Сначала удаляются все файлы калибровки из папки /tmp. Если они вам нужны, то сделайте
    #    бэкап перед запуском макроса;
    # 2. Паркуются все оси. Обратите внимание, что установка акселерометра не должна мешать парковке!
    # 3. В зависимости от значения параметра TEST_W, снимаются данные для оси X или W;
    # 4. Если не выключен параметр TEST_Y, то для оси Y снимаются данные в 3 точках: по центру стола,
    #    вблизи края стола, а также когда обе печатающие головы находятся вблизи центра стола;
    # 5. По полученным данным строятся АЧХ x.png и y.png, которые сохраняются в ~/printer_data/config.
    #    Если эти файлы уже есть, то они будут перезаписаны.
    # -------------------------
    # Параметры:
    # TEST_W=<0|1> - Если включить (установить 1), то тест будет проведён для оси W. Если выключить или
    #                не указывать, то для оси X;
    # TEST_Y=<0|1> - Если включить (установить 1) или не указывать, то тест будет проведён также для оси Y.
    RUN_SHELL_COMMAND CMD=remove_calibration_data
    G28
    {% if params.TEST_W|default(0)|int == 1 %}
        {% set x_edge = printer.configfile.settings['bed_mesh'].zero_reference_position[0]|float * 2 %}
        T1
    {% else %}
        {% set x_edge = 0 %}
        T0
    {% endif %}
    {% set x_center = printer.configfile.settings['bed_mesh'].zero_reference_position[0]|float %}
    {% set y_center = printer.configfile.settings['bed_mesh'].zero_reference_position[1]|float %}
    TEST_RESONANCES AXIS=x OUTPUT=raw_data POINT={x_center},{y_center},20
    {% if params.TEST_Y|default(1)|int == 1 %}
        TEST_RESONANCES AXIS=y OUTPUT=raw_data POINT={x_center},{y_center},20
        TEST_RESONANCES AXIS=y OUTPUT=raw_data POINT={x_edge},{y_center},20
        IDEX_MODE_FULL_CONTROL
        G1 X{x_center - 30} W{x_center + 30} F30000
        TEST_RESONANCES AXIS=y OUTPUT=raw_data POINT={x_center - 30},{y_center},20
        RUN_SHELL_COMMAND CMD=create_y_shaper_graph
    {% else %}
        # После снятия данных, они еще некоторое время записываются в файл. Если тест делается в том
        # числе для оси Y, то все данные успевают записаться к моменту построения АЧХ. Если тест для
        # оси Y не делается, то придётся просто подождать несколько секунд, чтобы данные точно
        # успели записаться.
        G4 P2000
        G4 P2000
        G4 P2000
        G4 P2000
        G4 P2000
    {% endif %}
    {% if params.TEST_W|default(0)|int == 1 %}
        RUN_SHELL_COMMAND CMD=create_w_shaper_graph
    {% else %}
        RUN_SHELL_COMMAND CMD=create_x_shaper_graph
    {% endif %}

[gcode_macro ENABLE_EQUAL_PA]
gcode:
    # Этот макрос включает режим одинакового Pressure Advance для печатающих голов.
    # О назначении режима читай в макросе SET_PRESSURE_ADVANCE
    SET_GCODE_VARIABLE MACRO=_IDEX_VARIABLES VARIABLE=equal_pa_mode VALUE=1

[gcode_macro DISABLE_EQUAL_PA]
gcode:
    # Этот макрос выключает режим одинакового Pressure Advance для печатающих голов.
    # О назначении режима читай в макросе SET_PRESSURE_ADVANCE
    SET_GCODE_VARIABLE MACRO=_IDEX_VARIABLES VARIABLE=equal_pa_mode VALUE=0


[gcode_macro SET_PRESSURE_ADVANCE]
rename_existing: BASE_SET_PRESSURE_ADVANCE
gcode:
    # Если режим одинакового pressure advance выключен (по умолчанию), то этот макрос ничего не делает.
    # Если режим одинакового pressure advance включен с помощью макроса ENABLE_EQUAL_PA, то команда
    # SET_PRESSURE_ADVANCE будет устанавливать одинаковое значение ADVANCE и SMOOTH_TIME для обеих
    # печатающих голов. В этом случае параметр EXTRUDER будет проигнорирован.
    # ----------
    # Данный режим используется для ускоренной калибровки pressure advance. Просто сгенерируйте
    # калибровочный G-код для зеркального или повторяющего режима, и перед его запуском включите режим
    # одинакового pressure advance. Таким образом можно за одну печать откалибровать сразу две печатающие
    # головы. После калибровки не забудьте выключить режим одинакового pressure advance с помощью макроса
    # DISABLE_EQUAL_PA или перезагрузив прошивку.
    {% if printer['gcode_macro _IDEX_VARIABLES'].equal_pa_mode|default(0)|int == 1 %}
        {% set ADVANCE = "" if (params.ADVANCE|default(none) is none) else "ADVANCE=" ~ params.ADVANCE %}
        {% set SMOOTH_TIME = "" if (params.SMOOTH_TIME|default(none) is none) else "SMOOTH_TIME=" ~ params.SMOOTH_TIME %}
        BASE_SET_PRESSURE_ADVANCE EXTRUDER=extruder {ADVANCE} {SMOOTH_TIME}
        BASE_SET_PRESSURE_ADVANCE EXTRUDER=extruder1 {ADVANCE} {SMOOTH_TIME}
    {% else %}
        BASE_SET_PRESSURE_ADVANCE {rawparams}
    {% endif %}